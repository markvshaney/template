// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Core Models

model User {
    id              String          @id @default(cuid())
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    email           String          @unique
    name            String?
    sessions        Session[]
    memories        Memory[]        // Keeping for backward compatibility
    documents       Document[]      // New relation for document storage
    searchQueries   SearchQuery[]   // Search history tracking
}

model Session {
    id        String      @id @default(cuid())
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt
    userId    String
    user      User        @relation(fields: [userId], references: [id])
    memories  Memory[]    // Keeping for backward compatibility
}

// Document-centric models for RAG

model Document {
    id                String      @id @default(cuid())
    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt
    title             String
    content           String      @db.Text
    contentType       String      // e.g., "text/plain", "text/html", "application/pdf"
    source            String?     // Source URL or identifier
    userId            String
    user              User        @relation(fields: [userId], references: [id])
    chunks            Chunk[]
    metadata          Json        // Additional document metadata
    fileName          String?     // Original filename
    fileSize          Int?        // File size in bytes
    mimeType          String?     // MIME type
    processingStatus  String      @default("pending") // pending, processing, completed, failed
    processingError   String?     // Error message if processing failed
    isIndexed         Boolean     @default(false)     // Whether the document has been indexed
    indexedAt         DateTime?   // When the document was indexed
    tags              String[]    // User-defined tags for organization
    
    @@index([userId])
    @@index([processingStatus])
    @@index([isIndexed])
    @@index([title]) // Individual indexes instead of fulltext
}

model Chunk {
    id              String                      @id @default(cuid())
    createdAt       DateTime                    @default(now())
    updatedAt       DateTime                    @updatedAt
    content         String                      @db.Text
    documentId      String
    document        Document                    @relation(fields: [documentId], references: [id], onDelete: Cascade)
    embedding       Unsupported("vector(1536)") // Vector embedding for similarity search
    keywords        String[]                    // For hybrid search
    metadata        Json                        // Chunk-specific metadata
    startPosition   Int                         // Starting position in document
    endPosition     Int                         // Ending position in document
    chunkIndex      Int                         // Sequential index of chunk in document
    isFirst         Boolean                     // Whether this is the first chunk
    isLast          Boolean                     // Whether this is the last chunk
    tokens          Int                         // Number of tokens in the chunk
    embeddingModel  String?                     // Model used to generate embedding
    
    @@index([documentId])
    @@index([chunkIndex])
}

// Dedicated embedding model for better organization and future extensibility
model Embedding {
    id              String                      @id @default(cuid())
    createdAt       DateTime                    @default(now())
    updatedAt       DateTime                    @updatedAt
    chunkId         String                      @unique
    modelName       String                      // Name of the embedding model used
    dimensions      Int                         // Dimensions of the embedding vector
    vector          Unsupported("vector(1536)") // The actual vector data
    
    @@index([chunkId])
}

// Web search models

model SearchQuery {
    id          String          @id @default(cuid())
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt
    query       String
    userId      String
    user        User            @relation(fields: [userId], references: [id])
    results     SearchResult[]
    metadata    Json            // Query context, filters, etc.
    provider    String          // Search provider used (google, bing, etc.)
    resultCount Int             // Number of results returned
    
    @@index([userId])
    @@index([createdAt])
}

model SearchResult {
    id              String        @id @default(cuid())
    createdAt       DateTime      @default(now())
    searchQueryId   String
    searchQuery     SearchQuery   @relation(fields: [searchQueryId], references: [id], onDelete: Cascade)
    title           String
    url             String
    snippet         String        @db.Text
    position        Int           // Result position/rank
    metadata        Json          // Additional result metadata
    isRelevant      Boolean?      // User feedback on relevance
    
    @@index([searchQueryId])
    @@index([url])
}

// Search result cache to reduce duplicate API calls
model SearchCache {
    id            String    @id @default(cuid())
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    query         String    @unique
    provider      String
    results       Json      // Cached search results
    expiresAt     DateTime  // When the cache expires
    
    @@index([query, provider])
    @@index([expiresAt])
}

// Legacy models - keeping for backward compatibility

model Memory {
    id            String                      @id @default(cuid())
    createdAt     DateTime                    @default(now())
    updatedAt     DateTime                    @updatedAt
    content       String                      @db.Text
    type          String // factual, procedural, social, episodic
    importance    Float                       @default(0)
    userId        String
    user          User                        @relation(fields: [userId], references: [id])
    sessionId     String
    session       Session                     @relation(fields: [sessionId], references: [id])
    embedding     Unsupported("vector(1536)") // Vector embedding with 1536 dimensions (for Mistral embeddings)
    keywords      String[] // For hybrid search
    metadata      Json // Additional metadata
    consolidation MemoryConsolidation?
}

model MemoryConsolidation {
    id           String   @id @default(cuid())
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
    memoryId     String   @unique
    memory       Memory   @relation(fields: [memoryId], references: [id])
    importance   Float    @default(0)
    lastReviewed DateTime @default(now())
    reviewCount  Int      @default(0)
    metadata     Json // Consolidation-specific metadata
}

model Specialization {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    name      String   @unique
    type      String // factual, procedural, social, episodic
    version   String
    active    Boolean  @default(false)
    metadata  Json // Specialization-specific metadata
}

// Vector Operations Extension
/// @postgres-vector
model VectorIndex {
    id        String                      @id @default(cuid())
    createdAt DateTime                    @default(now())
    updatedAt DateTime                    @updatedAt
    embedding Unsupported("vector(1536)") // Vector embedding with 1536 dimensions
    metadata  Json
}

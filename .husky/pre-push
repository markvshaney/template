#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Skip pre-push hook if SKIP_PRE_PUSH is true
if [ "$SKIP_PRE_PUSH" = "true" ]; then
  echo "â© Skipping pre-push checks as requested"
  exit 0
fi

echo "ğŸ” Running pre-push checks..."

# Run TypeScript type checking
echo "ğŸ“ Checking TypeScript types..."
npx tsc --noEmit || {
  echo "âŒ TypeScript check failed. Please fix type errors before pushing."
  echo "ğŸ’¡ Tip: Run 'npx tsc --noEmit' locally to see all type errors."
  echo "ğŸ’¡ To skip this check, use: SKIP_PRE_PUSH=true git push"
  exit 1
}

# Run linting on staged files only
echo "ğŸ§¹ Running linters..."
npx lint-staged || {
  echo "âŒ Linting failed. Please fix linting errors before pushing."
  echo "ğŸ’¡ Tip: Run 'npm run lint:fix' to fix linting issues."
  echo "ğŸ’¡ To skip this check, use: SKIP_PRE_PUSH=true git push"
  exit 1
}

# Run only critical tests, not the full suite
echo "ğŸ§ª Running critical tests..."
npx jest --config jest.config.cjs --bail --selectProjects critical --passWithNoTests || {
  echo "âŒ Critical tests failed. Please fix failing tests before pushing."
  echo "ğŸ’¡ Tip: Run 'npm test' locally to see test failures."
  echo "ğŸ’¡ To skip this check, use: SKIP_PRE_PUSH=true git push"
  exit 1
}

echo "âœ… All pre-push checks passed!" 